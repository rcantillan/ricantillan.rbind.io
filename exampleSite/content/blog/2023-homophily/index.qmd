---
date: 2022-10-26

title: homophily
subtitle: Is everywhere!
author: Roberto Cantillan

show_post_date: true
show_author_byline: true

draft: false

summary: |
    In this post I focus on analyzing homophily in a multidimensional way using the `ergm.ego` library, from the `statnet` group. For this I use the data from the Longitudinal Social Study of Chile (ELSOC).

format: hugo

freeze: auto
---


{{{< figure src="img/Fig14_A_600.gif" caption="Homophily" >}}}


## libraries
```{r, message=FALSE}
library(ergm)
library(ergm.ego)
library(car)
library(egor)
library(tidyverse)
library(tibble)
library(texreg)
library(prioritizr)
library(questionr)
```

## data
```{r}
load("/home/rober/Documents/ricantillan.rbind.io/dat/ELSOC/ELSOC_W02_v3.00_R.RData")
load("/home/rober/Documents/ricantillan.rbind.io/dat/ELSOC/ELSOC_W04_v2.01_R.RData")
load("/home/rober/Documents/ricantillan.rbind.io/dat/ELSOC/ELSOC_W01_v4.01_R.RData")
```


# ELSOC 2017

### Renombrar ID
```{r}
a<-elsoc_2017 %>% dplyr::rename(.egoID = idencuesta)
```

# Análisis ELSOC 2017
## Crear data frame alteris para 2017=a

Creamos subset con data de cada uno de los alteris mencionados, manteniendo el ID de cada ego en el cual están anidados. Las columnas de cada uno de los subset deben tener los mismos nombres. 
```{r}
alter_1<-a %>%
        dplyr::select(.egoID, 
                      sexo=r13_sexo_01, 
                      edad=r13_edad_01, 
                      educ=r13_educ_01,
                      relig=r13_relig_01, 
                      ideol=r13_ideol_01,
                      barrio=r13_barrio_01,
                      rel=r13_relacion_01)
#View(alter_1)
alter_2<-a %>%
        dplyr::select(.egoID, 
                      sexo=r13_sexo_02, 
                      edad=r13_edad_02, 
                      educ=r13_educ_02, 
                      relig=r13_relig_02, 
                      ideol=r13_ideol_02,
                      barrio=r13_barrio_02,
                      rel=r13_relacion_02)

alter_3<-a %>%
        dplyr::select(.egoID, 
                      sexo=r13_sexo_03, 
                      edad=r13_edad_03, 
                      educ=r13_educ_03, 
                      relig=r13_relig_03, 
                      ideol=r13_ideol_03,
                      barrio=r13_barrio_03,
                      rel=r13_relacion_03)

alter_4<- a %>%
        dplyr::select(.egoID, 
                      sexo=r13_sexo_04, 
                      edad=r13_edad_04, 
                      educ=r13_educ_04, 
                      relig=r13_relig_04, 
                      ideol=r13_ideol_04,
                      barrio=r13_barrio_04,
                      rel=r13_relacion_04)

alter_5<-a %>%
        dplyr::select(.egoID, 
                      sexo=r13_sexo_05, 
                      edad=r13_edad_05, 
                      educ=r13_educ_05, 
                      relig=r13_relig_05, 
                      ideol=r13_ideol_05,
                      barrio=r13_barrio_05,
                      rel=r13_relacion_05)
```

## setear

Creamos un vector adicional en cada subset de alteris con un número constante que identifica a que alter representa la data. 
```{r}
alter_1$n<-1
alter_2$n<-2
alter_3$n<-3
alter_4$n<-4
alter_5$n<-5
```

## Crear base de alteris en formato *long*

Con la función `rbind` agregamos la data hacia abajo en relación al orden establecido por los vectores númericos creados anteriormente. Es necesario que todas las columnas (variables) tengan los mismos nombres. Posteriormente con la función `arrange`, ordenamos la data en orden descendente en función del vector identificador de los egos (respondentes).  

```{r}
alteris<-rbind(alter_1,alter_2,alter_3,alter_4,alter_5)
alteris<-arrange(alteris, .egoID)
```

## Crear vector alter id

En el siguiente chunk creamos un vector identificador para cada uno de los alteris presentes en la data "alteris". Lo identificamos como objeto `tibble` y eliminamos el vector "n". 
```{r}
alteris   <- rowid_to_column(alteris, var = ".alterID")
alteris   <- as_tibble(alteris)
alteris$n <- NULL
```

## Recod alteris

Recodificamos los valores de los atributos de los alteris. 
```{r}
# NA
alteris[alteris=="-999"]<-NA
alteris[alteris=="-888"]<-NA

# Educación 
#edulab<-c('ltsecondary', 'secondary', 'technicaled', 'collegeed')
alteris$educ <-factor(Recode(alteris$educ ,"1=1;2:3=2;4=3;5=4"))
table(alteris$educ)

# Religión 
#relilab<-c('catholic','evangelical','other','none')
alteris$relig<-factor(Recode(alteris$relig,"1=1;2=2;3:4=4;5=3"))
table(alteris$relig)

# Ideología 
#ideolab<-c('rightwinger','centerright','center','centerleft','leftwinger','none')
alteris$ideol<-factor(Recode(alteris$ideol,"1=1;2=2;3=3;4=4;5=5;6=6"))
table(alteris$ideol)

# Edad 
alteris$edad<-as.numeric(alteris$edad)
#alteris$edad <-factor(Recode(alteris$edad ,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))

# Sexo 
#sexolab<-c('male','female')
alteris$sexo <-factor(Recode(alteris$sexo ,"1=1;2=2"))
table(alteris$sexo)

# Relación
alteris<-alteris%>%
  dplyr::mutate(rel=case_when(rel%in%1:3~"fam",
                              rel%in%4:5~"nofam"))
table(alteris$rel)

# Barrio 
alteris$barrio<-factor(Recode(alteris$barrio,"1=1;2=2"))
table(alteris$barrio)
#alteris<-na.omit(alteris)
```

### Borrar alteris con 5 parámetros con NA
```{r}
# Función para borrar casos con un número determinado de NA's. 
#delete.na <- function(DF, n=0) {
#  DF[rowSums(is.na(DF)) <= n,]
#}
#
#alteris<-delete.na(alteris, 4) #borro los casos que tienen más de 4 NA.  
```

## Data Frame Ego’s

Creamos un subset con la data de ego equivalente a la data de los alteris. Las nombramos de la misma manera. 
```{r}
egos <-a %>%
       dplyr::select(.egoID, 
                     sexo=m0_sexo, 
                     edad=m0_edad, 
                     educ=m01, 
                     relig=m38, 
                     ideol=c15)

egos <- as_tibble(egos)
```

## Recod data Ego's

Recodificamos las variables de la data de ego siguiendo el patrón de la data de alteris. 
```{r}
# NA
egos[egos=="-999"]<-NA
egos[egos=="-888"]<-NA

# Educación
egos$educ <-factor(Recode(egos$educ,"1:3=1;4:5=2;6:7=3;8:10=4"))
table(egos$educ)

# Religión
egos$relig<-factor(Recode(egos$relig,"1=1;2=2;3:6=3;7:9=4"))
table(egos$relig)

# Ideología
#ideolab2<-c('leftwinger','centerleft','center','centerright','rightwinger','none')
egos$ideol<-factor(Recode(egos$ideol,"0:2=5;3:4=4;5=3;6:7=2;8:10=1;11:12=6"))
table(egos$ideol)

# Edad
egos$edad<-as.numeric(egos$edad)
#egos$edad <-factor(Recode(egos$edad,"18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))

# Sexo
egos$sexo <-factor(Recode(egos$sexo,"1=1;2=2"))
table(egos$sexo)

# Barrio
egos$barrio <- matrix(rbinom(2473*5,1,0.6),2473,1) # Criterio minimalista
egos$barrio<-factor(Recode(egos$barrio,"1=1;0=2"))
table(egos$barrio)
```

# Crear objeto Egor (requerido para trabajar con función `ergm.ego`)

## Todos los alteris
```{r}
elsoc_ego <- egor(alters = alteris, 
                  egos = egos,
                  ID.vars = list(
                    ego = ".egoID",
                    alter = ".alterID"))

elsoc_ego<-as.egor(elsoc_ego)
#View(elsoc_ego$ego)
#View(elsoc_ego$alter)


elsoc_ego[["ego"]]  <-elsoc_ego[["ego"]]%>%drop_na(sexo)
elsoc_ego[["alter"]]<-elsoc_ego[["alter"]]%>%drop_na(sexo)
elsoc_ego[["ego"]]  <-elsoc_ego[["ego"]]%>%drop_na(educ)
elsoc_ego[["alter"]]<-elsoc_ego[["alter"]]%>%drop_na(educ)
elsoc_ego[["ego"]]  <-elsoc_ego[["ego"]]%>%drop_na(relig)
elsoc_ego[["alter"]]<-elsoc_ego[["alter"]]%>%drop_na(relig)
elsoc_ego[["ego"]]  <-elsoc_ego[["ego"]]%>%drop_na(ideol)
elsoc_ego[["alter"]]<-elsoc_ego[["alter"]]%>%drop_na(ideol)
elsoc_ego[["ego"]]<-elsoc_ego[["ego"]]%>%drop_na(barrio)
elsoc_ego[["alter"]]<-elsoc_ego[["alter"]]%>%drop_na(barrio)

```

# Modelos
## Modelo 6
```{r, message=FALSE}
modelo6<-ergm.ego(elsoc_ego~
                  nodematch("sexo", diff=TRUE),
                  control=control.ergm.ego(ppopsize="samp",
                                           ppop.wt="sample",
                                           stats.wt="data",
                                           stats.est="survey"),
                  ignore.max.alters=T,
                  boot.R = 1000000,
                  ergm = control.ergm(init.method = "MPLE",
                  init.MPLE.samplesize = 5e7,
                  MPLE.constraints.ignore = TRUE,
                  MCMLE.effectiveSize = NULL,
                  MCMC.burnin = 5e4,
                  MCMC.interval = 5e4,
                  MCMC.samplesize = 1000000,
                  parallel = 16,
                  SAN.nsteps = 5e7))

summary(modelo6)
```

## Modelo 7
```{r, message=FALSE}
modelo7<-ergm.ego(elsoc_ego~
                    nodematch("sexo", diff=TRUE)
                  + nodematch("educ", diff=TRUE),
                  control=control.ergm.ego(ppopsize="samp",
                                           ppop.wt="sample",
                                           stats.wt="data",
                                           stats.est="survey"),
                  ignore.max.alters=T,
                  boot.R = 1000000,
                  ergm = control.ergm(init.method = "MPLE",
                  init.MPLE.samplesize = 5e7,
                  MPLE.constraints.ignore = TRUE,
                  MCMLE.effectiveSize = NULL,
                  MCMC.burnin = 5e4,
                  MCMC.interval = 5e4,
                  MCMC.samplesize = 1000000,
                  parallel = 16,
                  SAN.nsteps = 5e7))

summary(modelo7)
```

## Modelo 8
```{r, message=FALSE}
modelo8<-ergm.ego(elsoc_ego~
                    nodematch("sexo", diff=TRUE)
                  + nodematch("educ", diff=TRUE)
                  + nodematch("relig", diff=TRUE),
                  control=control.ergm.ego(ppopsize="samp",
                                           ppop.wt="sample",
                                           stats.wt="data",
                                           stats.est="survey"),
                  ignore.max.alters=T,
                  boot.R = 1000000,
                  ergm = control.ergm(init.method = "MPLE",
                  init.MPLE.samplesize = 5e7,
                  MPLE.constraints.ignore = TRUE,
                  MCMLE.effectiveSize = NULL,
                  MCMC.burnin = 5e4,
                  MCMC.interval = 5e4,
                  MCMC.samplesize = 1000000,
                  parallel = 16,
                  SAN.nsteps = 5e7))

summary(modelo8)
```

## Modelo 9
```{r, message=FALSE}
modelo9<-ergm.ego(elsoc_ego~
                    nodematch("sexo", diff=TRUE)
                  + nodematch("educ", diff=TRUE)
                  + nodematch("relig", diff=TRUE)
                  + nodematch("ideol", diff=TRUE),
                  control=control.ergm.ego(ppopsize="samp",
                                           ppop.wt="sample",
                                           stats.wt="data",
                                           stats.est="survey"),
                  ignore.max.alters=T,
                  boot.R = 1000000,
                  ergm = control.ergm(init.method = "MPLE",
                  init.MPLE.samplesize = 5e7,
                  MPLE.constraints.ignore = TRUE,
                  MCMLE.effectiveSize = NULL,
                  MCMC.burnin = 5e4,
                  MCMC.interval = 5e4,
                  MCMC.samplesize = 1000000,
                  parallel = 16,
                  SAN.nsteps = 5e7))

summary(modelo9)
```

## Modelo 10
```{r, message=FALSE}
modelo10<-ergm.ego(elsoc_ego~
                    nodematch("sexo", diff=TRUE)
                  + nodematch("educ", diff=TRUE)
                  + nodematch("relig", diff=TRUE)
                  + nodematch("ideol", diff=TRUE)
                  + nodematch("barrio",diff=TRUE),
                  control=control.ergm.ego(ppopsize="samp",
                                           ppop.wt="sample",
                                           stats.wt="data",
                                           stats.est="survey"),
                  ignore.max.alters=T,
                  boot.R = 1000000,
                  ergm = control.ergm(init.method = "MPLE",
                  init.MPLE.samplesize = 5e7,
                  MPLE.constraints.ignore = TRUE,
                  MCMLE.effectiveSize = NULL,
                  MCMC.burnin = 5e4,
                  MCMC.interval = 5e4,
                  MCMC.samplesize = 1000000,
                  parallel = 16,
                  SAN.nsteps = 5e7))

summary(modelo10)
```

## Modelo 11
```{r, message=FALSE}
modelo11<-ergm.ego(elsoc_ego~
                    nodematch("sexo", diff=TRUE)
                  + nodematch("educ", diff=TRUE)
                  + nodematch("relig", diff=TRUE)
                  + nodematch("ideol", diff=TRUE)
                  + nodematch("barrio",diff=TRUE)
                  + absdiff("edad"),
                  control=control.ergm.ego(ppopsize="samp",
                                           ppop.wt="sample",
                                           stats.wt="data",
                                           stats.est="survey"),
                  ignore.max.alters=T,
                  boot.R = 1000000,
                  ergm = control.ergm(init.method = "MPLE",
                                      init.MPLE.samplesize = 5e7,
                                      MPLE.constraints.ignore = TRUE,
                                      MCMLE.effectiveSize = NULL,
                                      MCMC.burnin = 5e4,
                                      MCMC.interval = 5e4,
                                      MCMC.samplesize = 1000000,
                                      parallel = 16,
                                      SAN.nsteps = 5e7))

summary(modelo11)
```




